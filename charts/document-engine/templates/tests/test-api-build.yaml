apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "document-engine.fullname" . }}-test-api"
  labels:
    {{- include "document-engine.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: poke-api
      image: curlimages/curl
      envFrom:
        - secretRef:
            name: {{ include "document-engine.fullname" . }}
      {{- if .Values.apiAuth.externalSecret.name }}
        {{- with .Values.apiAuth.externalSecret }}
          {{- if .apiTokenKey }}
      env:
        - name: API_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ .name }}
              key: {{ .apiTokenKey }}
          {{- end }}
        {{- end }}
      {{- end }}
      command:
        - 'sh' 
        - '-c'
      args: 
        - |
          export URL="{{ include "document-engine.fullname" . }}:{{ .Values.service.port }}"
          export AUTH_HEADER="Authorization: Token token=${API_AUTH_TOKEN}"
          curl -v -X POST -H "${AUTH_HEADER}" \
               ${URL}/api/build \
              -H "accept: application/pdf" \
              -H "Content-Type: application/json" \
              -o /dev/null \
              -d '{
                    "parts": [
                      {
                        "html": { "url": "https://status.w3.org/"}
                      }
                    ]
                  }'
  restartPolicy: Never
