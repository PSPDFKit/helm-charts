{{- if and .Values.database.enabled 
           .Values.documentLifecycle.cleanupJob.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "document-engine.fullname" . }}-db-cleanup
  labels:
    {{- include "document-engine.labels" . | nindent 4 }}
data:
  {{- with .Values.documentLifecycle.cleanupJob }}
  {{- $url := printf "http://%s:%s/api/documents" ( include "document-engine.fullname" $ ) ( toString $.Values.service.port ) }}
  {{- $preservationDate :=  dateInZone "2006-01-02T15:04:05Z" ( now | mustDateModify ( printf "-%sh" (toString .keepHours) ) ) "UTC" }}
  run.sh: |
    #!/bin/sh
    set -e
    curl --request DELETE \
         --header "Authorization: Token token=${API_AUTH_TOKEN}" \
         --url {{ $url }}?end_date={{ $preservationDate }}
  {{- end }}
# Can be used for hash updating
  HELM_CHART_VERSION: {{ include "document-engine.chart" . | quote }}
{{- end }}
